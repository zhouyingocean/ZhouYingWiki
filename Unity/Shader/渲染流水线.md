
@[TOC](目录)

# 前言

学习Shader(着色器)之前，了解渲染流水线的工作流程是十分有必要的。渲染流水线的最终目的是将场景里虚拟相机Camera所能看到的内容生成或者说渲染成一张可以在终端设备上看到的二维纹理效果。

# 什么是渲染流水线

在计算机的图像渲染中，渲染流水线是由CPU和GPU共同完成。
计算机将三维场景中的顶点数据、纹理等信息处理成人眼可见的屏幕图像。

>《Real-Time Rendering, Third Edition》书中将渲染流程分为3个阶段：**应用阶段（Application Stage）**、**几何阶段（Geometry Stage）**、**光栅化阶段（Rasterizer Stage）**。

	tip:这里也只是概念性阶段，每一个阶段都包含了子流水线阶段。

- 应用阶段
这个阶段需要我们准备好场景数据，比如摄像机的位置、光源、游戏模型等，还要设置好模型的渲染状态，渲染状态指的是使用的材质、纹理、shader等。这些几何信息就是所谓的**渲染图元（rendering primitives）**，主要包含了渲染所需的点、线、面等。通常由CPU负责将这些渲染图元传递给几何阶段。
- 几何阶段
这一阶段GPU上进行，它依次对每个渲染图元进行逐顶点、逐多边形操作。最重要的任务是==将顶点坐标变换到屏幕空间==中去，通过将处理渲染图元后的二维顶点坐标、顶点对应的深度值、着色等信息传递给光栅化阶段。
- 光栅化阶段
该阶段同样是由GPU负责将接收到的顶点数据进行插值，逐像素处理产生屏幕上的像素，并决定哪些像素应该被绘制在屏幕上，渲染出最终的图像。

# CPU和GPU之间的通信

这里的通信发生在CPU应用阶段，大致分为3个阶段：
（1）把数据加载到显存中。
（2）设置渲染状态
（3）调用Draw Call

## 把数据加载到显存中

由CPU负责将渲染所需的数据从硬盘（Hard Drive,HDD）中加载到系统内存（Random Access Memory,RAM），然后进一步加载显卡上的存储空间--显存（Video Random Access Memory,VRAM）中，这也是由于显卡对显存的访问速度更快，而且大多数显卡对RAM 没有直接的访问权利
## 设置渲染状态

设置渲染状态可以理解为控制场景中网格的渲染方式，比如使用了哪个Shader、光源属性和材质等。通过合理的设置渲染状态，就能看到我们希望看到的效果。
## 调用DrawCall

DrawCall实际上是一个渲染命令，也就是CPU调用GPU渲染的过程，调用一次DrawCall就是由CPU发送需要被渲染的图元（primitives）列表给到GPU处理。

GPU接受到DrawCall命令后会根据渲染状态和顶点数据进行计算，然后会将计算得到的结果输出到屏幕上，也就是我们最终看到的效果。计算的过程也是一个流水线。

# GPU流水线

GPU流水线控制着几何阶段和光栅化阶段，每个阶段都负责不同的流水线，GPU也都给每个阶段提供了不同的可配置性和可编程性。

从上图中可看到GPU接收到来自DrawCall命令传来的顶点数据，并交由顶点着色器，从而开始GPU流水线工作。

## 顶点着色器

顶点着色器（Vertex Shader）负责处理来自CPU的顶点数据，输入一个顶点就调用一次顶点着色器。它的主要工作有：==坐标变化和逐顶点光照==，最后输出后续阶段所需的数据。

>坐标变换：就是对顶点坐标进行某种变换。最基本的顶点着色器都必须完成的一个坐标变换就是==将顶点坐标从模型空间转换到齐次裁剪空间==。

经过坐标变换后的顶点坐标再由硬件做透视除法，最终得到归一化的设备坐标 **（Normalized Device Coordinates, NDC）**。
## 曲面细分和几何着色器

曲面细分着色器（Tessellation Shader）和几何着色器（Geometry Shader）都是可选的着色器，前者用于细分图元；后者用于执行逐图元（Per-Primitive）的着色操作，或者被用于产生更多的图元。

## 裁剪

这一步是由硬件控制的，有些图元部分处于摄像机视野内，而视野外的就会被裁剪掉，新的顶点由视野交点处替代，可以自定义裁剪操作。

## 屏幕映射

这一步工作是将三维坐标系下的坐标（范围在单位立方体内），转换为屏幕坐标系（Screen Coordinates）,屏幕坐标系又和z坐标构成一个窗口坐标系（Window Coordinates），最后会传到光栅化阶段处理

	tip: OpenGL窗口坐标原点在左下角，DirectX窗口坐标原点在左上角

## 三角形设置

开始进入光栅化阶段，主要任务：计算每个图元覆盖了哪些像素，以及为这些像素计算它们的颜色。
作为光栅化阶段的第一个流水线任务就是设置三角形，即计算光栅化一个三角网络所需的信息。

## 三角形遍历

三角形遍历（Triangle Traversal）阶段将会检查每个像素是否被一个三角形网格所覆盖。如果被覆盖的话，就会生成一个片元（fragment），这个过程也被称为扫描变换（Scan Conversion）.
三角形遍历会对覆盖区域的像素进行插值，最后输出一个片元序列。

## 片元着色器

片元着色器（Fragment Shader）是一个非常重要的可编程着色器阶段。该阶段主要任务是纹理采样，输出的效果只会影响当前片元。

## 逐片元操作

渲染流水线的最后一步：逐片元操作（Per-Fragment Operations），具有高度可配置性。
主要任务
- 决定每个片元的可见性，如进行深度测试、模版测试等。
- 如果一个片元通过了所有的测试，就需要把这个片元的颜色值和已经存储在颜色缓冲区中的颜色进行合并，或者说是混合。

